<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Random Movie Picker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes scaleFlip {
      0%   { transform: scale(0.8); opacity: 0.5; }
      50%  { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .slot-flip { animation: scaleFlip 0.1s ease-in-out infinite; }

.provider-btn {
  width: 40px;
  height: 40px;
  margin-right: 0.5rem;
  background-color: rgba(255,255,255,0.08);
  border: 2px solid transparent;
  border-radius: 6px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  opacity: 0.85;
  transition:
    transform 0.15s ease,
    opacity   0.15s ease,
    box-shadow 0.15s ease,
    border-color 0.15s ease;
}

.provider-btn img {
  width: 32px;
  height: 32px;
  object-fit: contain;
}

.provider-btn:hover {
  opacity: 1;
  transform: scale(1.1);
  box-shadow: 0 2px 8px rgba(0,0,0,0.6);
}

.provider-btn.selected {
  opacity: 1;
  border-color: #38A169;
}



    #genreMenu { background-color: #4A5568; }
    #genreMenu .item {
      padding: 0.25rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: #E2E8F0;
      font-size: 0.875rem;
      white-space: nowrap;
    }
    #genreMenu .item:hover { background-color: #2D3748; }
    #genreMenu .item .check { visibility: hidden; color: #38A169; }
    #genreMenu .item.selected .check { visibility: visible; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4 pb-20">
  <div class="transform scale-90 lg:scale-100 w-full max-w-md space-y-4">
    <div id="randomizer" class="bg-gray-800 p-4 rounded space-y-4">
      <h1 class="text-4xl font-bold text-center">Random Movie Picker</h1>
      <div id="posterWrapper"
           class="bg-gray-700 rounded overflow-hidden mx-auto mb-6"
           style="width:288px; aspect-ratio:2/3;">
        <img id="moviePoster" class="hidden w-full h-full object-contain" alt=""/>
      </div>
      <button id="randomizeBtn"
              class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded font-medium text-sm"
              disabled>Loading...</button>
      <div id="result" class="hidden bg-gray-700 p-4 rounded text-center">
        <p id="movieResult" class="font-semibold text-white text-sm"></p>
      </div>
    </div>

    <div class="flex items-start">
      <!-- Genre Filter -->
      <div class="relative inline-block">
        <button id="genreToggle"
                class="bg-transparent text-gray-200 font-semibold text-sm hover:underline flex items-center space-x-1 px-2 py-1">
          <span>▾</span><span>Genres</span>
        </button>
        <div id="genreMenu"
             class="absolute hidden min-w-max rounded shadow-lg z-10 bottom-full mb-1 left-0
                    lg:left-auto lg:right-full lg:mr-4 max-h-[70vh] overflow-y-auto">
        </div>
      </div>

      <!-- Streaming Providers -->
      <div class="ml-auto flex flex-col items-center">
        <div class="text-gray-200 font-semibold text-sm mb-1">Where to stream</div>
        <div id="providerFilter" class="flex"></div>
      </div>
    </div>
  </div>

  <!-- Attribution -->
  <div class="absolute bottom-2 right-4 text-xs text-gray-500">
    Data provided by <a href="https://www.themoviedb.org" target="_blank" class="underline">TMDb</a>
  </div>

  <script>
    // ─── CONFIG ───────────────────────────────────────────────────────
    // Only these provider_ids (Big 9)
    const ALLOWED_PROVIDER_IDS = new Set([
      8,   // Netflix
      119, // Prime Video
      15,  // Hulu
      337, // Disney+
      384, // HBO Max
      39,  // Peacock
      531, // Paramount+
      387, // Tubi
      2    // Apple TV+
    ]);

    // ─── SHOW PROVIDERS ───────────────────────────────────────────────
    // Only flatrate/free/adSupported, and only Big 9
    function showProviders(movie) {
      const wrap = document.getElementById('providerFilter');
      wrap.innerHTML = '';
      if (!Array.isArray(movie.watch_providers)) return;

      movie.watch_providers
        .filter(p =>
          ALLOWED_PROVIDER_IDS.has(p.provider_id) &&
          ['flatrate','free','adSupported'].includes(p.provider_type)
        )
        .forEach(p => {
          if (!p.logo_path) return;
          const a = document.createElement('a');
          a.href   = movie.watch_link || '#';
          a.target = '_blank';
          a.className = 'provider-btn';
          const img = document.createElement('img');
          img.src = `https://image.tmdb.org/t/p/w92${p.logo_path}`;
          img.alt = p.provider_name;
          a.appendChild(img);
          wrap.appendChild(a);
        });
    }

    // ─── GENRE DROPDOWN ──────────────────────────────────────────────
    const genreMap = {
      0:"Any Genre",28:"Action",12:"Adventure",16:"Animation",35:"Comedy",
      80:"Crime",99:"Documentary",18:"Drama",10751:"Family",
      14:"Fantasy",36:"History",27:"Horror",10402:"Music",
      9648:"Mystery",10749:"Romance",878:"Sci-Fi",
      10770:"TV Movie",53:"Thriller",10752:"War",37:"Western"
    };
    const genreToggle = document.getElementById('genreToggle');
    const genreMenu   = document.getElementById('genreMenu');
    let selectedGenres= new Set([0]);

    Object.entries(genreMap).forEach(([id,name]) => {
      const div = document.createElement('div');
      div.className     = 'item';
      div.dataset.genre = id;
      div.innerHTML     = `<span>${name}</span><span class="check">✓</span>`;
      if (id==="0") div.classList.add('selected');
      div.addEventListener('click', e => {
        e.stopPropagation();
        if (+id===0) {
          selectedGenres = new Set([0]);
          genreMenu.querySelectorAll('.item')
                   .forEach(it=>it.classList.toggle('selected', it.dataset.genre==="0"));
        } else {
          selectedGenres.has(+id) ? selectedGenres.delete(+id) : selectedGenres.add(+id);
          div.classList.toggle('selected');
          selectedGenres.delete(0);
          genreMenu.querySelector('.item[data-genre="0"]').classList.remove('selected');
        }
        genreMenu.classList.add('hidden');
        randomize();
      });
      genreMenu.appendChild(div);
    });
    genreToggle.addEventListener('click', e => {
      e.stopPropagation();
      genreMenu.classList.toggle('hidden');
    });
    document.addEventListener('click', ()=>genreMenu.classList.add('hidden'));

    // ─── CORE RANDOMIZER ─────────────────────────────────────────────
    const btn   = document.getElementById('randomizeBtn');
    const imgEl = document.getElementById('moviePoster');
    const res   = document.getElementById('result');
    const txt   = document.getElementById('movieResult');
    let movies  = [], spinCount=30, spinSpeed=20;

    function showError(msg) {
      res.classList.remove('hidden');
      txt.textContent = msg;
      btn.textContent = 'Error';
      btn.disabled = true;
    }

    function randomize() {
      if (!movies.length) return;

      // 1) only pick from movies available on Big 9
      let pool = movies.filter(m =>
        Array.isArray(m.watch_providers) &&
        m.watch_providers.some(p => ALLOWED_PROVIDER_IDS.has(p.provider_id))
      );

      // 2) apply genre filter
      const gf = [...selectedGenres].filter(g=>g!==0);
      if (gf.length) {
        pool = pool.filter(m => gf.every(id => m.genre_ids.includes(id)));
        if (!pool.length) return showError('No movies match your genres.');
      }

      // 3) spin animation
      res.classList.add('hidden');
      imgEl.classList.remove('hidden');
      imgEl.classList.add('slot-flip');
      btn.disabled = true;

      // 4) Fisher–Yates & pick first N
      const copy = pool.slice();
      for (let i=copy.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [copy[i],copy[j]] = [copy[j],copy[i]];
      }
      const picks = copy.slice(0, spinCount);

      // 5) animate through picks
      let i=0;
      (function flip(){
        const m = picks[i++];
        imgEl.src = m.src;
        txt.textContent = `${m.title} (${m.year})`;
        if (i < picks.length) {
          setTimeout(flip, spinSpeed);
        } else {
          imgEl.classList.remove('slot-flip');
          res.classList.remove('hidden');
          btn.textContent = 'Randomize Movie';
          btn.disabled = false;
          showProviders(m);
        }
      })();
    }

    // ─── LOAD CACHED DATA ────────────────────────────────────────────
    fetch('./data/movies.json')
      .then(r => r.ok ? r.json() : Promise.reject(r.status))
      .then(arr => {
        movies = arr
          .filter(m=>m.poster_path)
          .map(m=>({
            title:          m.title,
            year:           m.release_date?.slice(0,4) || '',
            src:            `https://image.tmdb.org/t/p/w500${m.poster_path}`,
            genre_ids:      m.genre_ids || [],
            watch_providers:m.watch_providers || [],
            watch_link:     m.watch_link || ''
          }));
        btn.textContent = 'Randomize Movie';
        btn.disabled = false;
      })
      .catch(err => {
        console.error('Failed to load movie list:', err);
        showError('Failed to load movie list.');
      });

    btn.addEventListener('click', randomize);
  </script>
</body>
</html>
