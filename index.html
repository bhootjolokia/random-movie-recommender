<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Randomly pick a top rated movie</title>
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
  <script src='https://cdn.tailwindcss.com'></script>
  <style>
    :root {
      --font-sans: 'Inter', system-ui, sans-serif;
      --color-bg: #121212;
      --color-base: #1E1E1E;
      --color-accent: #2DD4BF;
      --color-text: #E5E7EB;
      --color-text-muted: #9CA3AF;
      --radius: 0.5rem;
    }

    html { height: 100%; }
    body {
      height: 100%;
      background: var(--color-bg); 
      color: var(--color-text); 
      font-family: var(--font-sans);
      padding: 1rem;
      margin: 0;
      box-sizing: border-box;
      overflow-y: auto; /* Allow scrolling on desktop if needed */
    }
    
    /* --- MOBILE-FIRST STYLES --- */
    .page-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100%;
      min-height: 100%;
    }
    .main-content {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
    }

    /* Hide desktop genre list by default */
    #desktopGenreContainer {
        display: none;
    }
    
    h1 {
      font-size: clamp(1.5rem, 5vw, 2.25rem); 
      line-height: 1.1;
      font-weight: 700;
      margin-bottom: 0.75rem;
      text-align: center;
      flex-shrink: 0; 
    }

    #posterWrapper {
      background: var(--color-bg); 
      border-radius: var(--radius);
      width: 100%;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden; 
      display: flex;
      aspect-ratio: 2 / 3; 
    }

    #filmstrip {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      transition: transform 2.5s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    #filmstrip .filmstrip-image { width: 100%; height: 100%; object-fit: contain; position: absolute; }

    .btn {
      display: block; width: 100%; padding: 0.75rem; background: var(--color-base);
      color: var(--color-text); font-weight: 600; border: none; border-radius: var(--radius);
      font-size: 0.875rem; transition: background 0.2s, transform 0.1s; cursor: pointer;
      flex-shrink: 0;
      margin-bottom: 1.5rem;
    }
    .btn:disabled { opacity: 0.6; cursor: default; }
    .btn:hover:not(:disabled), .btn:focus:not(:disabled) { background: var(--color-accent); color: #121212; transform: translateY(-2px); outline: none; }
    .btn:active { transform: translateY(0); }

    #result { text-align: center; min-height: 1.25rem; visibility: hidden; flex-shrink: 0; }
    #movieResult { font-weight: 600; font-size: 0.875rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; max-width: clamp(240px, 90vw, 320px); box-sizing: border-box; }

    .controls {
      width: 100%; display: flex; justify-content: space-between;
      flex-wrap: wrap; gap: 0.5rem; position: relative; margin-top: 1rem; flex-shrink: 0;
    }
    #genreToggle, #streamLink { font-size: 0.875rem; font-weight: 600; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: var(--radius); }
    #streamLink:hover, #streamLink:focus { background: rgba(45, 212, 191, 0.1); border-radius: var(--radius); outline: none; }

    /* Mobile Popup Styles */
    #genreModalContainer {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      z-index: 1000; display: flex; align-items: center; justify-content: center;
      opacity: 0; pointer-events: none; transition: opacity 200ms ease;
    }
    #genreModalContainer.open { opacity: 1; pointer-events: auto; }

    #genreOverlay {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(4px);
    }

    #genreMenu {
      position: relative; background: var(--color-base); border-radius: var(--radius);
      width: 90%; max-width: 340px; max-height: 80vh; display: flex; flex-direction: column;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5); transform: scale(0.95); transition: transform 200ms ease;
    }
    #genreModalContainer.open #genreMenu { transform: scale(1); }

    .genre-menu-header {
      padding: 0.75rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
    }
    .genre-menu-header h2 { font-size: 1rem; font-weight: 600; }
    #genreDoneBtn {
      background: var(--color-accent); color: #121212; border: none;
      padding: 0.25rem 0.75rem; border-radius: var(--radius);
      font-size: 0.875rem; font-weight: 600; cursor: pointer;
    }

    #mobileGenreList { overflow-y: auto; padding: 0.5rem; }
    #mobileGenreList .item {
      padding: 0.5rem 0.5rem; display: flex; align-items: center; gap: 0.5rem;
      font-size: 0.9rem; white-space: nowrap; cursor: pointer; position: relative; border-radius: 0.25rem;
    }
    .check { visibility: hidden; color: #38A169; }
    .item.selected .check { visibility: visible; }
    
    .site-footer {
      width: 100%; margin-top: auto; padding-top: 1.5rem;
      display: flex; flex-wrap: wrap; justify-content: space-between;
      align-items: center; gap: 0.5rem 1rem; color: var(--color-text-muted);
      flex-shrink: 0; font-size: clamp(0.7rem, 2.5vw, 0.75rem);
    }
    .site-footer a { color: var(--color-text-muted); text-decoration: none; }
    .site-footer a:hover { color: var(--color-accent); text-decoration: underline; }
    .footer-center { flex-basis: 100%; text-align: center; }

    /* --- DESKTOP STYLES (min-width: 1024px) --- */
    @media (min-width: 1024px) {
        body { overflow: hidden; } /* Lock scrolling on desktop */
        
        .page-container {
            display: grid;
            grid-template-columns: 260px 1fr; /* Left column for genres, right for main content */
            gap: 2rem;
            align-items: start;
            height: 100%;
            max-width: 1200px; /* Sensible max width for the whole layout */
            margin: 0 auto;
        }

        /* Show desktop genre panel and style it */
        #desktopGenreContainer {
            display: block;
            background: var(--color-base);
            border-radius: var(--radius);
            padding: 1rem;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        #desktopGenreContainer h2 {
            font-size: 1.125rem;
            font-weight: 700;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        #desktopGenreList {
            overflow-y: auto;
            flex-grow: 1; /* Makes list fill available space */
        }
        #desktopGenreList .item {
            padding: 0.4rem 0.25rem;
            border-radius: 0.25rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
        }
        #desktopGenreList .item:hover {
            background: rgba(45, 212, 191, 0.1);
        }
        
        /* The main content area on the right */
        .main-content {
            height: 100%;
            max-width: 320px; /* Constrain the movie part */
            margin: 0 auto; /* Center it within the grid cell */
        }

        /* Hide mobile genre button and popup */
        #genreToggle, #genreModalContainer {
            display: none;
        }
        /* Make the "Where to stream" link take up the full width of its container */
        .controls {
            justify-content: flex-end;
        }
    }
  </style>
</head>
<body>
  <div class="page-container">
    
    <!-- NEW: Container for the desktop genre list -->
    <div id="desktopGenreContainer">
        <h2>Genres</h2>
        <div id="desktopGenreList"></div>
    </div>

    <!-- Main content area for the randomizer -->
    <div class="main-content">
        <h1>Randomly pick a top rated movie</h1>
        
        <div id='posterWrapper'>
          <div id="filmstrip"></div>
        </div>
        <button id='randomizeBtn' class='btn' disabled>Randomize Movie</button>

        <div id='result'><div id='movieResult'></div></div>

        <div class='controls'>
          <!-- This button is now hidden on desktop -->
          <button id='genreToggle'>â–¾ Genres</button>
          
          <a id='streamLink' href='#' target='_blank'>Where to stream</a>
          
          <!-- This modal is now hidden on desktop -->
          <div id="genreModalContainer">
            <div id="genreOverlay"></div>
            <div id='genreMenu' role='menu'>
                <div class="genre-menu-header">
                    <h2>Select Genres</h2>
                    <button id="genreDoneBtn">Done</button>
                </div>
                <div id="mobileGenreList"></div>
            </div>
          </div>
        </div>

        <footer class="site-footer">
          <a href="mailto:movierandomizertool@gmail.com" class="footer-left">Contact Us</a>
          <a href="#" class="footer-right">Privacy Policy</a>
          <div class="footer-center">Data provided by <a href="https://www.themoviedb.org" target="_blank">TMDb</a></div>
        </footer>
    </div>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const TMDB_BASE = 'https://www.themoviedb.org/movie';
    const SEEN_MOVIES_CAP = 50;
    let movies = [];
    let selectedGenres = new Set([0]);
    let isSpinning = false;
    let seenMovies = [];
    
    const btn = document.getElementById('randomizeBtn');
    const res = document.getElementById('result');
    const txt = document.getElementById('movieResult');
    const genreToggle = document.getElementById('genreToggle');
    const streamLink = document.getElementById('streamLink');
    const filmstrip = document.getElementById('filmstrip');
    const posterWrapper = document.getElementById('posterWrapper');
    
    // Selectors for both mobile and desktop genre lists
    const genreModalContainer = document.getElementById('genreModalContainer');
    const genreMenu = document.getElementById('genreMenu');
    const mobileGenreList = document.getElementById('mobileGenreList');
    const genreOverlay = document.getElementById('genreOverlay');
    const genreDoneBtn = document.getElementById('genreDoneBtn');
    const desktopGenreList = document.getElementById('desktopGenreList');

    const genreMap = {0:'Any Genre',28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Sci-Fi',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'};
    
    // Function to handle genre selection
    const handleGenreClick = (genreId) => {
        if (genreId === 0) { selectedGenres.clear(); selectedGenres.add(0); } else {
          selectedGenres.delete(0); if (selectedGenres.has(genreId)) { selectedGenres.delete(genreId); if (selectedGenres.size === 0) selectedGenres.add(0); } else { selectedGenres.add(genreId); }
        }
        updateGenreSelection();
        randomize();
    };

    // Populate BOTH the mobile and desktop lists
    Object.entries(genreMap).forEach(([id,name]) => {
      const createGenreElement = (genreId, genreName) => {
          const el = document.createElement('div'); el.className = 'item'; el.dataset.genre = genreId;
          const check = document.createElement('span'); check.className = 'check'; check.innerHTML = 'âœ“Â ';
          const text = document.createTextNode(genreName);
          el.appendChild(check);
          el.appendChild(text);
          el.addEventListener('click', (e) => {
              e.stopPropagation();
              handleGenreClick(+genreId);
          });
          return el;
      };
      
      const mobileEl = createGenreElement(id, name);
      const desktopEl = createGenreElement(id, name);

      mobileGenreList.appendChild(mobileEl);
      desktopGenreList.appendChild(desktopEl);
    });

    function updateGenreSelection() { 
        document.querySelectorAll('.item').forEach(i => {
            i.classList.toggle('selected', selectedGenres.has(+i.dataset.genre)); 
        });
    }
    
    function closeGenreMenu() {
      genreModalContainer.classList.remove('open');
    }
    genreToggle.addEventListener('click', (e) => { e.stopPropagation(); genreModalContainer.classList.add('open'); });
    genreDoneBtn.addEventListener('click', closeGenreMenu);
    genreOverlay.addEventListener('click', closeGenreMenu);

    fetch('data/movies.json')
      .then(r => r.ok ? r.json() : Promise.reject('Failed to load movie data.'))
      .then(arr => {
        movies = arr.filter(m => m.poster_path).map(m => ({
          id: m.id, title: m.title, year: m.release_date ? m.release_date.slice(0,4) : 'N/A', src: `https://image.tmdb.org/t/p/w500${m.poster_path}`, genre_ids: m.genre_ids, watch_link: m.watch_link
        }));
        
        const PRE_WARM_COUNT = 15;
        const tempSeen = new Set();
        while(tempSeen.size < PRE_WARM_COUNT && tempSeen.size < movies.length) {
            tempSeen.add(movies[Math.floor(Math.random() * movies.length)]);
        }
        seenMovies = Array.from(tempSeen);

        btn.disabled = false;
        updateGenreSelection();
        const firstMovie = seenMovies[0] || movies[0];
        pickNewMovie(movies, firstMovie);
      })
      .catch(err => { console.error(err); txt.textContent = 'Could not load movies.'; res.style.visibility = 'visible'; });

    btn.addEventListener('click', randomize);

    function pickNewMovie(pool, movie) {
        if (!pool || !movie) {
            filmstrip.innerHTML = ''; txt.textContent = 'No movies match the selected genres.'; streamLink.href = '#'; res.style.visibility = 'visible';
            return;
        }
        filmstrip.style.transition = 'none';
        filmstrip.innerHTML = `<img class="filmstrip-image" src="${movie.src}" alt="${movie.title}" style="top: 0;">`;
        filmstrip.style.transform = 'translateY(0)';
        txt.textContent = `${movie.title} (${movie.year})`;
        streamLink.href = movie.watch_link || `${TMDB_BASE}/${movie.id}/watch?locale=US`;
        res.style.visibility = 'visible';
        if (!seenMovies.some(sm => sm.id === movie.id)) {
            seenMovies.unshift(movie);
            if (seenMovies.length > SEEN_MOVIES_CAP) seenMovies.pop();
        }
    }
    
    async function randomize() {
      if (isSpinning || !movies.length) return;
      isSpinning = true;
      btn.disabled = true;
      try {
        let pool = movies.filter(m => !seenMovies.some(sm => sm.id === m.id));
        if (pool.length === 0) pool = movies; 
        const fs = [...selectedGenres].filter(g => g !== 0);
        if (fs.length > 0) pool = pool.filter(m => fs.every(g => m.genre_ids.includes(g)));
        if (pool.length === 0) { pickNewMovie(null, null); return; }
        const winner = pool[Math.floor(Math.random() * pool.length)];
        await preloadImages([winner.src]);
        await performFastSpin(winner);
        pickNewMovie(pool, winner);
      } catch (error) { console.error("An error occurred during randomization:", error); txt.textContent = "Oops! Something went wrong.";
      } finally { isSpinning = false; btn.disabled = false; }
    }

    async function performFastSpin(winner) {
      const stripLength = 30;
      let stripHTML = '';
      const posterHeight = posterWrapper.clientHeight;
      if (posterHeight === 0) return; 
      const movieSource = seenMovies.length > 0 ? seenMovies : movies;
      for (let i = 0; i < stripLength; i++) {
        const movieForStrip = movieSource[i % movieSource.length];
        stripHTML += `<img class="filmstrip-image" src="${movieForStrip.src}" style="top: ${i * 100}%;" alt="">`;
      }
      stripHTML += `<img class="filmstrip-image" src="${winner.src}" style="top: ${stripLength * 100}%;" alt="${winner.title}">`;
      filmstrip.style.transition = 'none';
      filmstrip.style.transform = 'translateY(0)';
      filmstrip.innerHTML = stripHTML;
      await new Promise(r => requestAnimationFrame(() => r()));
      txt.textContent = 'Finding a movie...';
      const finalPosition = -posterHeight * stripLength;
      filmstrip.style.transition = 'transform 2.5s cubic-bezier(0.25, 0.1, 0.25, 1)';
      filmstrip.style.transform = `translateY(${finalPosition}px)`;
      await new Promise(resolve => {
        const fallback = setTimeout(() => { console.warn('Animation fallback timer fired.'); resolve(); }, 2600); 
        filmstrip.addEventListener('transitionend', () => { clearTimeout(fallback); resolve(); }, { once: true });
      });
    }
    function preloadImages(srcArray) {
      const promises = srcArray.map(src => new Promise((resolve) => { const img = new Image(); img.onload = resolve; img.onerror = resolve; img.src = src; }));
      return Promise.all(promises);
    }
  });
  </script>
</body>
</html>
