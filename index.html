<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Randomly pick a top rated movie</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --color-bg:     #1E293B; /* slate-800 */
      --color-card:   #243449; /* slate-700 */
      --color-base:   #2E3B52; /* slate-600 */
      --color-accent: #22D3EE; /* cyan-400 */
      --color-text:   #F1F5F9; /* slate-100 */
      --radius:       0.75rem;
    }
    html, body {
      background: var(--color-bg);
      color: var(--color-text);
      font-family: 'Inter', system-ui, sans-serif;
      margin: 0; padding: 0;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      box-sizing: border-box;
    }

    h1 {
      font-size: 2rem;           /* larger */
      font-weight: 700;
      margin: 0 0 1.5rem;        /* extra spacing */
      white-space: nowrap;
    }

    .randomizer {
      background: var(--color-card);
      border-radius: var(--radius);
      padding: 1.25rem;
      box-shadow: 0 6px 16px rgba(0,0,0,0.6);
      width: 100%; max-width: 320px;
    }
    #posterWrapper {
      background: var(--color-base);
      border-radius: var(--radius);
      overflow: hidden;
      width: 100%; aspect-ratio: 2/3;
      margin-bottom: 1.25rem;
    }
    #moviePoster {
      width:100%; height:100%; object-fit:contain;
      display:none; /* hide until loaded */
    }

    .btn {
      width:100%;
      padding:0.75rem;
      background: var(--color-base);
      color: var(--color-text);
      border:none;
      border-radius: var(--radius);
      font-size:0.9rem;
      font-weight:600;
      cursor:pointer;
      transition: background .2s, transform .1s;
    }
    .btn:disabled { opacity:.6; cursor: default; }
    .btn:not(:disabled):hover,
    .btn:not(:disabled):focus {
      background: var(--color-accent);
      color: #1E293B;
      transform: translateY(-2px);
      outline: none;
    }
    .btn:active { transform: translateY(0); }

    /* controls row */
    .controls { display: flex; justify-content: space-between; align-items: flex-start; margin-top:1rem; width:100%; max-width:320px; }

    /* footer attribution */
    .attribution {
      position: fixed;
      bottom: .5rem; left: .75rem;
      font-size: .75rem;
      color: #94A3B8; /* slate-400 */
      pointer-events: none;
    }

    /* genre dropdown */
    #genreMenu {
      background: var(--color-base);
      border-radius: var(--radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      max-height: 60vh; overflow-y: auto;
    }
    #genreMenu .item {
      padding:.5rem 1rem;
      cursor:pointer;
      display:flex; align-items:center; justify-content:space-between;
      color: var(--color-text);
      font-size:.9rem;
      transition: background .15s;
    }
    #genreMenu .item:hover,
    #genreMenu .item:focus { background: #334155; outline:none; }
    #genreMenu .check { visibility:hidden; color:#4ADE80; }
    #genreMenu .selected .check { visibility:visible; }

    /* providers */
    .provider-btn {
      width:48px; height:48px;
      margin-right:.5rem;
      transition:transform .15s, opacity .15s;
      opacity:.85;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .provider-btn img { width:40px; height:40px; object-fit:contain; }
    .provider-btn:hover,
    .provider-btn:focus {
      transform:scale(1.1); opacity:1; outline:none;
    }
  </style>
</head>
<body>

  <h1>Randomly pick a top rated movie</h1>

  <div class="randomizer">
    <div id="posterWrapper">
      <img id="moviePoster" alt="Movie Poster">
    </div>
    <button id="randomizeBtn" class="btn" disabled>Loading…</button>
    <div id="result" class="text-center mt-4 hidden">
      <p id="movieResult" class="font-semibold"></p>
    </div>
  </div>

  <div class="controls">
    <!-- genre -->
    <div class="relative inline-block">
      <button id="genreToggle"
              class="text-sm font-semibold hover:underline px-2 py-1"
              aria-haspopup="true" aria-expanded="false">
        ▾ Genres
      </button>
      <div id="genreMenu" class="absolute bottom-full mb-1 left-0 hidden z-20">
      </div>
    </div>
    <!-- providers -->
    <div class="flex flex-col items-center">
      <div class="text-sm font-semibold mb-1">Where to stream</div>
      <div id="providerFilter" class="flex"></div>
    </div>
  </div>

  <div class="attribution">
    Data provided by <a href="https://www.themoviedb.org" target="_blank" class="underline">TMDb</a>
  </div>

  <script>
    const ALLOWED = new Set([8,119,15,337,384,39,531,387,2]);
    let movies = [], selectedGenres = new Set([0]);
    const spinCount = 30, spinSpeed = 20;
    const btn = document.getElementById('randomizeBtn');
    const imgEl = document.getElementById('moviePoster');
    const res   = document.getElementById('result');
    const txt   = document.getElementById('movieResult');

    function showError(msg) {
      res.classList.remove('hidden');
      txt.textContent = msg;
      btn.textContent = 'Error';
      btn.disabled    = true;
    }

    function showProviders(m) {
      const wrap = document.getElementById('providerFilter');
      wrap.innerHTML = '';
      (m.watch_providers||[])
        .filter(p => ALLOWED.has(p.provider_id) &&
                     ['flatrate','free','adSupported'].includes(p.provider_type))
        .forEach(p => {
          if (!p.logo_path) return;
          const a = document.createElement('a');
          a.href   = m.watch_link || '#';
          a.target = '_blank';
          a.className = 'provider-btn';
          const i = document.createElement('img');
          i.src = `https://image.tmdb.org/t/p/w92${p.logo_path}`;
          i.alt = p.provider_name;
          a.appendChild(i);
          wrap.appendChild(a);
        });
    }

    // genre setup
    const genreMap = {
      0:"Any",28:"Action",12:"Adventure",16:"Animation",35:"Comedy",
      80:"Crime",99:"Doc",18:"Drama",10751:"Family",14:"Fantasy",
      36:"History",27:"Horror",10402:"Music",9648:"Mystery",
      10749:"Romance",878:"Sci-Fi",10770:"TV Movie",53:"Thriller",
      10752:"War",37:"Western"
    };
    const menu = document.getElementById('genreMenu');
    Object.entries(genreMap).forEach(([id,name])=>{
      const d=document.createElement('div');
      d.className='item'; d.tabIndex=0;
      d.dataset.genre=id;
      d.innerHTML=`<span>${name}</span><span class="check">✓</span>`;
      if(id==='0') d.classList.add('selected');
      d.addEventListener('click',()=>toggleGenre(+id));
      d.addEventListener('keydown',e=>{ if(e.key==='Enter'||e.key===' ') toggleGenre(+id) });
      menu.appendChild(d);
    });
    function toggleGenre(id){
      if(id===0){
        selectedGenres=new Set([0]);
        menu.querySelectorAll('.item').forEach(it=>
          it.classList.toggle('selected', it.dataset.genre==='0')
        );
      } else {
        const el=menu.querySelector(`.item[data-genre="${id}"]`);
        if(selectedGenres.has(id)) selectedGenres.delete(id);
        else selectedGenres.add(id);
        el.classList.toggle('selected');
        selectedGenres.delete(0);
        menu.querySelector('.item[data-genre="0"]').classList.remove('selected');
      }
      menu.classList.add('hidden');
      randomize();
    }
    document.getElementById('genreToggle').addEventListener('click',e=>{
      e.stopPropagation();
      const open = !menu.classList.toggle('hidden');
      e.currentTarget.setAttribute('aria-expanded', open);
    });
    document.addEventListener('click',()=>menu.classList.add('hidden'));

    async function randomize(){
      if(!movies.length) return;
      let pool = movies.filter(m =>
        Array.isArray(m.watch_providers) &&
        m.watch_providers.some(p=>ALLOWED.has(p.provider_id))
      );
      const gf=[...selectedGenres].filter(g=>g!==0);
      if(gf.length){
        pool = pool.filter(m=>gf.every(id=>m.genre_ids.includes(id)));
        if(!pool.length) return showError('No movies match.');
      }
      btn.disabled=true;
      res.classList.add('hidden');
      imgEl.style.display='none';
      imgEl.classList.add('slot-flip');

      // pick spinCount samples (unique if possible)
      let picks;
      if(pool.length>=spinCount){
        picks = pool.slice();
        for(let i=picks.length-1;i>0;i--){
          const j=Math.floor(Math.random()*(i+1));
          [picks[i],picks[j]]=[picks[j],picks[i]];
        }
        picks = picks.slice(0,spinCount);
      } else {
        picks = Array.from({length:spinCount},()=> pool[Math.floor(Math.random()*pool.length)]);
      }

      let i=0;
      (function flip(){
        const m=picks[i++];
        imgEl.src = m.src;
        imgEl.alt = m.title;
        imgEl.onload = () => { imgEl.style.display='block'; };
        txt.textContent = `${m.title} (${m.year})`;
        if(i<picks.length) setTimeout(flip, spinSpeed);
        else {
          imgEl.classList.remove('slot-flip');
          res.classList.remove('hidden');
          btn.textContent='Randomize Movie';
          btn.disabled=false;
          showProviders(m);
        }
      })();
    }

    // load JSON
    fetch('data/movies.json')
      .then(r=> r.ok? r.json():Promise.reject(r.status))
      .then(arr=>{
        movies = arr.filter(m=>m.poster_path).map(m=>({
          title: m.title,
          year:  m.release_date?.slice(0,4)||'',
          src:   `https://image.tmdb.org/t/p/w342${m.poster_path}`,
          genre_ids: m.genre_ids||[],
          watch_providers: m.watch_providers||[],
          watch_link: m.watch_link||''
        }));
        btn.textContent='Randomize Movie';
        btn.disabled=false;
      })
      .catch(err=> { console.error(err); showError('Failed to load list.'); });

    btn.addEventListener('click', randomize);
  </script>

</body>
</html>
