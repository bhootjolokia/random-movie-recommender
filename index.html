<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Random Movie Picker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes scaleFlip {
      0%   { transform: scale(0.8); opacity: 0.5; }
      50%  { transform: scale(1.2); opacity: 1; }
      100% { transform: scale(1); opacity: 1; }
    }
    .slot-flip { animation: scaleFlip 0.1s ease-in-out infinite; }

    /* Provider Chip Styling */
    .provider-btn {
      width: 32px; height: 32px;
      opacity: 0.6;
      border: 2px solid transparent;
      border-radius: 4px;
      transition: opacity .2s, border-color .2s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 0.25rem;
    }
    .provider-btn img {
      width: 24px; height: 24px;
      object-fit: contain;
      filter: none;
    }
    .provider-btn:hover { opacity: 1; }
    .provider-btn.selected {
      opacity: 1;
      border-color: #38A169;
    }

    /* Genre Dropdown Styling */
    #genreMenu { background-color: #4A5568; }
    #genreMenu .item {
      padding: 0.25rem 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.25rem;
      color: #E2E8F0;
      font-size: 0.875rem;
      white-space: nowrap;
    }
    #genreMenu .item:hover { background-color: #2D3748; }
    #genreMenu .item .check { visibility: hidden; color: #38A169; }
    #genreMenu .item.selected .check { visibility: visible; }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 flex items-center justify-center min-h-screen p-4 pb-20">
  <div class="transform scale-90 lg:scale-100 w-full max-w-md space-y-4">

    <!-- Randomizer Box -->
    <div id="randomizer" class="bg-gray-800 p-4 rounded space-y-4">
      <h1 class="text-4xl font-bold text-center">Random Movie Picker</h1>
      <div id="posterWrapper"
           class="bg-gray-700 rounded overflow-hidden mx-auto mb-6"
           style="width:288px; aspect-ratio:2/3;">
        <img id="moviePoster" class="hidden w-full h-full object-contain" alt=""/>
      </div>
      <button id="randomizeBtn"
              class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded font-medium text-sm"
              disabled>Loading...</button>
      <div id="result" class="hidden bg-gray-700 p-4 rounded text-center">
        <p id="movieResult" class="font-semibold text-white text-sm"></p>
      </div>
    </div>

    <!-- Controls: Genres left, Providers right -->
    <div class="flex items-start">
      <!-- Genres -->
      <div class="relative inline-block">
        <button id="genreToggle"
                class="bg-transparent text-gray-200 font-semibold text-sm hover:underline flex items-center space-x-1 px-2 py-1">
          <span>▾</span><span>Genres</span>
        </button>
        <div id="genreMenu"
             class="absolute hidden min-w-max rounded shadow-lg z-10 bottom-full mb-1 left-0
                    lg:left-auto lg:right-full lg:mr-4 max-h-[70vh] overflow-y-auto">
        </div>
      </div>
      <!-- Providers -->
      <div class="ml-auto flex flex-col items-center">
        <div class="text-gray-200 font-semibold text-sm mb-1">Where to watch</div>
        <div id="providerFilter" class="flex"></div>
      </div>
    </div>
  </div>

  <!-- Attribution -->
  <div class="absolute bottom-2 right-4 text-xs text-gray-500">
    Data provided by <a href="https://www.themoviedb.org" target="_blank" class="underline">TMDb</a>
  </div>

  <script>
    // ─── SHOW DYNAMIC PROVIDERS ───
    function showProviders(movie) {
      const container = document.getElementById('providerFilter');
      container.innerHTML = '';
      if (!movie.watch_providers?.length) return;
      movie.watch_providers.forEach(p => {
        const a = document.createElement('a');
        a.href = movie.watch_link || '#';
        a.target = '_blank';
        a.className = 'provider-btn';
        const img = document.createElement('img');
        img.src = `https://image.tmdb.org/t/p/w92${p.logo_path}`;
        img.alt = p.provider_name;
        a.appendChild(img);
        container.appendChild(a);
      });
    }

    // ─── GENRE LOGIC ───
    const genreMap = {
      0:"Any Genre",28:"Action",12:"Adventure",16:"Animation",35:"Comedy",
      80:"Crime",99:"Documentary",18:"Drama",10751:"Family",
      14:"Fantasy",36:"History",27:"Horror",10402:"Music",
      9648:"Mystery",10749:"Romance",878:"Sci-Fi",
      10770:"TV Movie",53:"Thriller",10752:"War",37:"Western"
    };
    const genreToggle = document.getElementById('genreToggle');
    const genreMenu   = document.getElementById('genreMenu');
    let selectedGenres= new Set([0]);

    Object.entries(genreMap).forEach(([id,name]) => {
      const d = document.createElement('div');
      d.className     = 'item';
      d.dataset.genre = id;
      d.innerHTML     = `<span>${name}</span><span class="check">✓</span>`;
      if (id==="0") d.classList.add('selected');
      d.addEventListener('click', e => {
        e.stopPropagation();
        if (+id===0) {
          selectedGenres = new Set([0]);
          genreMenu.querySelectorAll('.item')
                   .forEach(it=>it.classList.toggle('selected', it.dataset.genre==="0"));
        } else {
          selectedGenres.has(+id) ? selectedGenres.delete(+id) : selectedGenres.add(+id);
          d.classList.toggle('selected');
          selectedGenres.delete(0);
          genreMenu.querySelector('.item[data-genre="0"]').classList.remove('selected');
        }
        genreMenu.classList.add('hidden');
        randomize();
      });
      genreMenu.appendChild(d);
    });
    genreToggle.addEventListener('click', e=>{
      e.stopPropagation();
      genreMenu.classList.toggle('hidden');
    });
    document.addEventListener('click', ()=>genreMenu.classList.add('hidden'));

    // ─── CORE RANDOMIZER ───
    const randomizeBtn = document.getElementById('randomizeBtn');
    const moviePoster  = document.getElementById('moviePoster');
    const resultDiv    = document.getElementById('result');
    const movieResult  = document.getElementById('movieResult');
    let preloaded      = [];
    const animationCount=30, animationSpeed=20;

    function showError(msg) {
      resultDiv.classList.remove('hidden');
      movieResult.textContent = msg;
      randomizeBtn.textContent = 'Error';
      randomizeBtn.disabled = true;
    }

    function randomize() {
      if (!preloaded.length) return;
      // filter by genres
      const gf = [...selectedGenres].filter(g=>g!==0);
      let pool = preloaded;
      if (gf.length) {
        pool = pool.filter(m=>gf.every(id=>m.genre_ids.includes(id)));
        if (!pool.length) return showError('No movies match your genres.');
      }
      // spin animation
      resultDiv.classList.add('hidden');
      moviePoster.classList.remove('hidden');
      moviePoster.classList.add('slot-flip');
      randomizeBtn.disabled = true;

      const cand = pool.slice();
      for (let i=cand.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [cand[i],cand[j]] = [cand[j],cand[i]];
      }
      const picks = cand.slice(0, animationCount);
      let i=0;
      (function flip(){
        const m = picks[i++];
        moviePoster.src = m.src;
        movieResult.textContent = `${m.title} (${m.year})`;
        if (i<picks.length) setTimeout(flip,animationSpeed);
        else {
          moviePoster.classList.remove('slot-flip');
          resultDiv.classList.remove('hidden');
          randomizeBtn.textContent = 'Randomize Movie';
          randomizeBtn.disabled = false;
          showProviders(m);
        }
      })();
    }

    // fetch cached data (now includes watch_link & watch_providers)
    fetch('/data/movies.json')
      .then(r=>r.ok?r.json():Promise.reject(r.status))
      .then(arr=>{
        preloaded = arr.filter(m=>m.poster_path).map(m=>({
          title: m.title,
          year:  m.release_date?.slice(0,4)||'',
          src:   `https://image.tmdb.org/t/p/w500${m.poster_path}`,
          genre_ids: m.genre_ids||[],
          watch_link: m.watch_link||'',
          watch_providers: m.watch_providers||[]
        }));
        randomizeBtn.textContent = 'Randomize Movie';
        randomizeBtn.disabled = false;
      })
      .catch(err=>{ console.error(err); showError('Failed to load movie list.') });

    randomizeBtn.addEventListener('click', randomize);
  </script>
</body>
</html>
