<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Randomly pick a top rated movie</title>
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
  <script src='https://cdn.tailwindcss.com'></script>
  <style>
    /* Poster flip animation */
    @keyframes slotFlip { 0% { transform: rotateX(0deg); } 50% { transform: rotateX(90deg); } 100% { transform: rotateX(0deg); } }
    #moviePoster.slot-flip { animation: slotFlip 0.6s ease-in-out; backface-visibility: hidden; }

    :root {
      --font-sans: 'Inter', system-ui, sans-serif;
      --color-bg: #121212;
      --color-base: #1E1E1E;
      --color-card: #1F1F1F;
      --color-accent: #2DD4BF;
      --color-text: #E5E7EB;
      --radius: 0.5rem;
    }

    html { background: var(--color-bg); color: var(--color-text); font-family: var(--font-sans); }
    body {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      margin: 0;
      /* Always leave space at bottom so content isn't flush against edge */
      padding-bottom: 2rem;
    }
    h1 { font-size: 2.25rem; line-height: 1.1; font-weight: 700; margin-bottom: 1rem; letter-spacing: 0.025em; white-space: nowrap; }

    .randomizer {
      background: var(--color-card);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      width: 100%;
      max-width: clamp(240px, 90vw, 320px);
      /* Limit card height to viewport for small screens */
      max-height: 80vh;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: max-width 0.2s, max-height 0.2s;
      /* Reserve space beneath card for one line of title */
      margin-bottom: 1.25rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      transition: max-width 0.2s;
      /* Reserve space beneath card for one line of title */
      margin-bottom: 1.25rem;
    }

    #posterWrapper {
      background: var(--color-base);
      border-radius: var(--radius);
      overflow: hidden;
      width: 100%;
      aspect-ratio: 2/3;
      margin-bottom: 1rem;
    }
    /* Ensure poster image always shows */
    #moviePoster {
      display: block !important;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* Hide poster until src is set */
    #moviePoster {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }
    }
    #moviePoster { width: 100%; height: 100%; object-fit: contain;  }

    .btn {
      display: block;
      width: 100%;
      padding: 0.75rem;
      background: var(--color-base);
      color: var(--color-text);
      font-weight: 600;
      border: none;
      border-radius: var(--radius);
      font-size: 0.875rem;
      transition: background 0.2s, transform 0.1s;
      cursor: pointer;
      /* Match space above and below button */
      margin-bottom: 1rem; }
    .btn:disabled { opacity: 0.6; cursor: default; }
    .btn:hover:not(:disabled), .btn:focus:not(:disabled) {
      /* Randomize button hover color */
      background: var(--color-accent);
      color: #121212;
      transform: translateY(-2px);
      outline: none;
    } }
    .btn:active { transform: translateY(0); }

    #result {
      text-align: center;
      /* reserve space for controls under title */
      margin: 1rem 0 2rem; /* top 1rem, bottom 2rem */
      min-height: 1.25rem;
      visibility: hidden;
    }
    #movieResult {
      font-weight: 600;
      font-size: 0.875rem;
      /* Keep title on a single line with ellipsis for overflow */
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      box-sizing: border-box;
    }

    .controls {
      width: 100%;
      max-width: clamp(200px, 90vw, 280px);
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
      /* Ensure dropdown menu is positioned relative to this block */
      position: relative;
      margin-top: 0;  /* no extra gap above */
      margin-bottom: 1rem; /* minimal breathing room before footer */
    }
    #genreToggle, #streamLink { font-size: 0.875rem; font-weight: 600; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: var(--radius); }

    /* Dropdown */
    #genreMenu { position: absolute; bottom: 100%; right: calc(100% + 0.25rem); transform-origin: bottom right; max-height: 60vh; overflow-y: auto; background: var(--color-base); border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.5); opacity: 0; transform: translateY(0.5rem) scale(0.95); pointer-events: none; transition: opacity 150ms ease, transform 150ms ease; z-index: 1000; }
    #genreMenu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
    #genreMenu .item { padding: 0.2rem 0.4rem; display: flex; align-items: center; gap: 0.3rem; font-size: 0.8125rem; white-space: nowrap; cursor: pointer; position: relative; }
    /* Elegant hover indicator */
    #genreMenu .item:hover {
      background: rgba(45, 212, 191, 0.1); /* subtle accent highlight */
    }
    /* Visual cue for "Where to stream" hover */
    #streamLink:hover, #streamLink:focus {
      background: rgba(45, 212, 191, 0.1);
      border-radius: var(--radius);
      outline: none;
    }
    #genreMenu .check { visibility: hidden; color: #38A169; }
    #genreMenu .item.selected .check { visibility: visible; }
      /* Handle tall card on small vertical screens */
    @media (max-height: 700px) {
      /* Increase bottom padding on very short viewports */
      body {
        padding-bottom: 4rem;
      }
      /* Reduce card height and allow internal scrolling */
      .randomizer {
        max-height: 60vh;
        overflow-y: auto;
        padding: 0.5rem;
      }
      /* Ensure body has room for controls at bottom */
      body {
        padding-top: 0.5rem;
        padding-bottom: 3rem;
      }
      /* Controls remain below the title even on small screens */
    }
  </style>
</head>
<body>
  <div class="page-wrapper">

  <h1>Randomly pick a top rated movie</h1>
  <div class='randomizer'>
    <div id='posterWrapper'><img id='moviePoster' alt='Movie poster'></div>
    <button id='randomizeBtn' class='btn' disabled>Randomize Movie</button>
  </div>

  <div id='result'><div id='movieResult'></div></div>

  <div class='controls'>
    <button id='genreToggle'>â–¾ Genres</button>
    <a id='streamLink' href='#' target='_blank'>Where to stream</a>
    <div id='genreMenu' role='menu'></div>
  </div>

  <!-- Footer Links -->
  <a href="#" class="privacy-policy text-xs text-gray-400" style="position:absolute; bottom:1.5rem; right:0.5rem;">Privacy Policy</a>
  <div class="attribution text-xs text-gray-500" style="position:absolute; bottom:0.5rem; right:0.5rem;">Data provided by <a href="https://www.themoviedb.org" target="_blank" class="underline">TMDb</a></div>
  <a href="mailto:movierandomizertool@gmail.com" class="contact-us text-xs text-gray-400" style="position:absolute; bottom:0.5rem; left:0.5rem;">Contact Us</a>
  </div>

  <script>
  document.addEventListener('DOMContentLoaded', () => {
    const TMDB_BASE = 'https://www.themoviedb.org/movie';
    const spinCount = 30, spinSpeed = 20;
    let movies = [];
    let selectedGenres = new Set([0]);

    const btn = document.getElementById('randomizeBtn');
    const img = document.getElementById('moviePoster');
    const res = document.getElementById('result');
    const txt = document.getElementById('movieResult');
    const genreToggle = document.getElementById('genreToggle');
    const genreMenu = document.getElementById('genreMenu');
    const streamLink = document.getElementById('streamLink');

    const genreMap = {0:'Any Genre',28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Sci-Fi',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'};

    // Populate genre menu
    Object.entries(genreMap).forEach(([id,name]) => {
      const el = document.createElement('div');
      el.className = 'item'; el.dataset.genre = id;
      el.textContent = name;
      el.addEventListener('click', () => {
        if (+id === 0) selectedGenres = new Set([0]);
        else {
          selectedGenres.has(+id) ? selectedGenres.delete(+id) : selectedGenres.add(+id);
          selectedGenres.delete(0);
        }
        document.querySelectorAll('#genreMenu .item').forEach(i => {
          i.classList.toggle('selected', selectedGenres.has(+i.dataset.genre));
        });
        randomize();
      });
      genreMenu.appendChild(el);
    });

    // Toggle genre menu
    genreToggle.addEventListener('click', e => {
      e.stopPropagation();
      genreMenu.classList.toggle('open');
    });
    document.addEventListener('click', () => {
      genreMenu.classList.remove('open');
    });

    // Fetch full movie list
    fetch('data/movies.json')
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(arr => {
        movies = arr.filter(m => m.poster_path).map(m => ({
          id: m.id,
          title: m.title,
          year: m.release_date.slice(0,4),
          src: `https://image.tmdb.org/t/p/w342${m.poster_path}`,
          genre_ids: m.genre_ids,
          watch_link: m.watch_link
        }));
        btn.disabled = false;
        // show initial
        const m = movies[Math.floor(Math.random()*movies.length)];
        img.src = m.src;
        txt.textContent = `${m.title} (${m.year})`;
        streamLink.href = m.watch_link || `${TMDB_BASE}/${m.id}/watch?locale=US`;
        res.style.visibility = 'visible';
      })
      .catch(console.error);

    btn.addEventListener('click', randomize);

    function randomize() {
      if (!movies.length) return;
      let pool = movies;
      const fs = [...selectedGenres].filter(g => g !== 0);
      if (fs.length) pool = pool.filter(m => fs.every(g => m.genre_ids.includes(g)));
      btn.disabled = true;
      let i = 0;
      (function spin() {
        const m = pool[Math.floor(Math.random()*pool.length)];
        img.src = m.src;
        txt.textContent = `${m.title} (${m.year})`;
        streamLink.href = m.watch_link || `${TMDB_BASE}/${m.id}/watch?locale=US`;
        res.style.visibility = 'visible';
        if (++i < spinCount) setTimeout(spin, spinSpeed);
        else btn.disabled = false;
      })();
    }
  });
</script>
</body>
</html>
