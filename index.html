<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='UTF-8'>
  <meta http-equiv='X-UA-Compatible' content='IE=edge'>
  <meta name='viewport' content='width=device-width, initial-scale=1.0'>
  <title>Randomly pick a top rated movie</title>
  <link href='https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap' rel='stylesheet'>
  <script src='https://cdn.tailwindcss.com'></script>
  <style>
    /* Poster flip animation */
    @keyframes slotFlip { 0% { transform: rotateX(0deg); } 50% { transform: rotateX(90deg); } 100% { transform: rotateX(0deg); } }
    #moviePoster.slot-flip { animation: slotFlip 0.6s ease-in-out; backface-visibility: hidden; }

    :root {
      --font-sans: 'Inter', system-ui, sans-serif;
      --color-bg: #121212;
      --color-base: #1E1E1E;
      --color-card: #1F1F1F;
      --color-accent: #2DD4BF;
      --color-text: #E5E7EB;
      --radius: 0.5rem;
    }

    html { background: var(--color-bg); color: var(--color-text); font-family: var(--font-sans); }
    body { min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 1rem 1rem 4rem; margin: 0; }

    h1 {
      font-size: 2.25rem;
      line-height: 1.1;
      font-weight: 700;
      margin-bottom: 1.5rem;
      letter-spacing: 0.025em;
      white-space: nowrap;
    }

    .randomizer {
      background: var(--color-card);
      border-radius: var(--radius);
      padding: 1rem;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      width: 100%;
      max-width: 320px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      transition: max-width 0.2s;
    }

    #posterWrapper {
      background: var(--color-base);
      border-radius: var(--radius);
      overflow: hidden;
      width: 100%;
      aspect-ratio: 2/3;
      margin-bottom: 1.5rem;
    }

    #moviePoster { width: 100%; height: 100%; object-fit: contain; display: none; }

    .btn {
      width: 100%; padding: 0.75rem; background: var(--color-base); color: var(--color-text); font-weight: 600;
      border: none; border-radius: var(--radius); font-size: 0.875rem; transition: background 0.2s, transform 0.1s; cursor: pointer; margin-bottom: 1rem;
    }
    .btn:disabled { opacity: 0.6; cursor: default; }
    .btn:hover:not(:disabled), .btn:focus:not(:disabled) { background: var(--color-accent); color: #121212; transform: translateY(-2px); outline: none; }
    .btn:active { transform: translateY(0); }

    #result { text-align: center; margin-bottom: 1rem; display: none; }
    #movieResult { font-weight: 600; font-size: 0.875rem; }

    .controls {
      width: 100%; max-width: 320px;
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 0.5rem; position: relative; transition: max-width 0.2s;
    }

    #genreToggle, #streamLink {
      font-size: 0.875rem; font-weight: 600; cursor: pointer; padding: 0.25rem 0.5rem; border-radius: var(--radius);
      transition: background 150ms, text-decoration 150ms;
    }
    #genreToggle { color: var(--color-text); background: transparent; text-decoration: none; }
    #streamLink { color: var(--color-accent); background: transparent; text-decoration: none; }
    #streamLink:hover, #streamLink:focus { text-decoration: underline; background: rgba(45,212,191,0.1); outline: none; }

    /* Dropdown */
    #genreMenu {
      position: absolute; bottom: 100%; right: calc(100% + 0.25rem);
      transform-origin: bottom right; max-height: 60vh; 
      background: var(--color-base); border-radius: var(--radius); box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      opacity: 0; transform: translateY(0.5rem) scale(0.95);
      pointer-events: none; transition: opacity 150ms ease, transform 150ms ease; z-index: 1000;
    }
    #genreMenu.open { opacity: 1; transform: translateY(0) scale(1); pointer-events: auto; }
    #genreMenu .item {
      padding: 0.2rem 0.4rem; display: flex; align-items: center; gap: 0.3rem;
      font-size: 0.8125rem; white-space: nowrap; cursor: pointer;
    }
    #genreMenu .check { visibility: hidden; color: #38A169; }
    #genreMenu .item.selected .check { visibility: visible; }
  </style>
</head>
<body>
  <h1>Randomly pick a top rated movie</h1>
  <div class='randomizer'>
    <div id='posterWrapper'><img id='moviePoster' alt='Movie poster'></div>
    <button id='randomizeBtn' class='btn' disabled><span class='btn-text'>Loading…</span></button>
    <div id='result' aria-live='polite'><div id='movieResult'></div></div>
  </div>
  <div class='controls'>
    <button id='genreToggle' aria-haspopup='menu' aria-expanded='false'>▾ Genres</button>
    <a id='streamLink' href='#' target='_blank' rel='noopener noreferrer'>Where to stream</a>
    <div id='genreMenu' role='menu'></div>
  </div>

  <!-- Footer Links -->
  <a href="#" class="privacy-policy text-xs text-gray-400" style="position:absolute; bottom:1.5rem; right:0.5rem;">Privacy Policy</a>
  <div class="attribution text-xs text-gray-500" style="position:absolute; bottom:0.5rem; right:0.5rem;">Data provided by <a href="https://www.themoviedb.org" target="_blank" class="underline">TMDb</a></div>
  <a href="mailto:movierandomizertool@gmail.com" class="contact-us text-xs text-gray-400" style="position:absolute; bottom:0.5rem; left:0.5rem;">Contact Us</a>

</body>
<script>
  const TMDB_BASE = 'https://www.themoviedb.org/movie';
  const spinCount = 30, spinSpeed = 20;
  let movies = [], selectedGenres = new Set([0]);
  const genreMap = {
    0: 'Any Genre',
    28: 'Action', 12: 'Adventure', 16: 'Animation', 35: 'Comedy',
    80: 'Crime', 18: 'Drama', 10751: 'Family', 14: 'Fantasy',
    36: 'History', 27: 'Horror', 10402: 'Music', 9648: 'Mystery',
    10749: 'Romance', 878: 'Sci-Fi', 10770: 'TV Movie', 53: 'Thriller',
    10752: 'War', 37: 'Western'
  };

  const genreToggle = document.getElementById('genreToggle');
  const genreMenu = document.getElementById('genreMenu');
  Object.entries(genreMap).forEach(([id, name]) => {
    const item = document.createElement('div');
    item.className = 'item'; item.dataset.genre = id;
    item.innerHTML = `<span>${name}</span><span class='check'>✓</span>`;
    item.addEventListener('click', () => selectGenre(+id));
    genreMenu.appendChild(item);
  });

  genreToggle.addEventListener('click', e => {
    e.stopPropagation();
    const open = !genreMenu.classList.toggle('open');
    genreToggle.setAttribute('aria-expanded', open);
  });

  document.addEventListener('click', () => {
    genreMenu.classList.remove('open');
    genreToggle.setAttribute('aria-expanded', 'false');
  });

  function selectGenre(id) {
    if (id === 0) selectedGenres = new Set([0]);
    else {
      if (selectedGenres.has(id)) selectedGenres.delete(id);
      else selectedGenres.add(id);
      selectedGenres.delete(0);
    }
    document.querySelectorAll('#genreMenu .item').forEach(el =>
      el.classList.toggle('selected', selectedGenres.has(+el.dataset.genre))
    );
    randomize();
  }

  document.getElementById('randomizeBtn').addEventListener('click', randomize);
  fetch('data/movies.json')
    .then(r => r.ok ? r.json() : Promise.reject())
    .then(arr => {
      movies = arr.filter(m => m.poster_path).map(m => ({
        id: m.id,
        title: m.title,
        year: m.release_date?.slice(0,4) || '',
        src: `https://image.tmdb.org/t/p/w342${m.poster_path}`,
        genre_ids: m.genre_ids || [],
        watch_link: m.watch_link || ''
      }));
      document.getElementById('randomizeBtn').textContent = 'Randomize Movie';
      document.getElementById('randomizeBtn').disabled = false;
    })
    .catch(() => {
      document.getElementById('movieResult').textContent = 'Failed to load movie list.';
    });

  function randomize() {
    const btn = document.getElementById('randomizeBtn');
    const img = document.getElementById('moviePoster');
    const res = document.getElementById('result');
    const txt = document.getElementById('movieResult');
    if (!movies.length) return;
    res.style.display = 'none';
    img.style.display = 'block';
    let pool = movies;
    const filters = [...selectedGenres].filter(g => g !== 0);
    if (filters.length) {
      pool = pool.filter(m => filters.every(id => m.genre_ids.includes(id)));
      if (!pool.length) {
        txt.textContent = 'No movies match your genres.';
        res.style.display = 'block';
        return;
      }
    }
    const picks = pool.length >= spinCount
      ? pool.sort(() => 0.5 - Math.random()).slice(0, spinCount)
      : Array.from({ length: spinCount }, () => pool[Math.floor(Math.random() * pool.length)]);
    btn.disabled = true;
    let i = 0;
    (function flip() {
      const m = picks[i++];
      img.src = m.src;
      txt.textContent = `${m.title} (${m.year})`;
      if (i < picks.length) setTimeout(flip, spinSpeed);
      else {
        res.style.display = 'block';
        btn.disabled = false;
        document.getElementById('streamLink').href = m.watch_link || `${TMDB_BASE}/${m.id}/watch?locale=US`;
      }
    })();
  }
</script>
</html>
