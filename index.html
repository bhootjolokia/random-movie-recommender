// No longer need DOMContentLoaded because of the 'defer' attribute on the script tag.
const TMDB_BASE = 'https://www.themoviedb.org/movie';
const IMG_BASE = 'https://image.tmdb.org/t/p/';
const SEEN_MOVIES_CAP = 50;
const DEFAULT_MOVIE_ID = 693134; // Dune: Part Two - for the preloaded poster

let movies = [];
let fullMovieList = [];
let spinCount = 0;
let selectedGenres = new Set([0]);
let isSpinning = false;
let seenMovies = [];

const btn = document.getElementById('randomizeBtn');
const res = document.getElementById('result');
const txt = document.getElementById('movieResult');
const genreToggle = document.getElementById('genreToggle');
const streamLink = document.getElementById('streamLink');
const filmstrip = document.getElementById('filmstrip');
const loadingPlaceholder = document.getElementById('loading-placeholder');
const genreModalContainer = document.getElementById('genreModalContainer');
const genreMenu = document.getElementById('genreMenu');
const genreList = document.getElementById('genreList');
const genreOverlay = document.getElementById('genreOverlay');
const genreMenuCloseBtn = document.querySelector('.genre-menu-close');
const genreMap = {28:'Action',12:'Adventure',16:'Animation',35:'Comedy',80:'Crime',18:'Drama',10751:'Family',14:'Fantasy',36:'History',27:'Horror',10402:'Music',9648:'Mystery',10749:'Romance',878:'Science Fiction',10770:'TV Movie',53:'Thriller',10752:'War',37:'Western'};

let isGenreMenuBuilt = false;

function buildGenreMenu() {
  if (isGenreMenuBuilt) return;
  const sortedGenreList = Object.entries(genreMap).sort(([, nameA], [, nameB]) => nameA.localeCompare(nameB));
  sortedGenreList.unshift(['0', 'Any Genre']);
  sortedGenreList.forEach(([id, name]) => {
    const el = document.createElement('div');
    el.className = 'item';
    el.dataset.genre = id;
    el.setAttribute('role', 'menuitemradio');
    const check = document.createElement('span');
    check.className = 'check';
    check.innerHTML = 'âœ“';
    const text = document.createElement('span');
    text.textContent = name;
    el.appendChild(check);
    el.appendChild(text);
    el.addEventListener('click', (e) => {
      e.stopPropagation();
      const genreId = +id;
      if (genreId === 0) {
        selectedGenres.clear();
        selectedGenres.add(0);
      } else {
        selectedGenres.delete(0);
        if (selectedGenres.has(genreId)) {
          selectedGenres.delete(genreId);
          if (selectedGenres.size === 0) selectedGenres.add(0);
        } else {
          selectedGenres.add(genreId);
        }
      }
      updateGenreSelection();
      randomize();
      closeGenreMenu();
    });
    genreList.appendChild(el);
  });
  isGenreMenuBuilt = true;
}

function updateGenreSelection() {
  document.querySelectorAll('#genreList .item').forEach(i => {
    const isSelected = selectedGenres.has(+i.dataset.genre);
    i.classList.toggle('selected', isSelected);
    i.setAttribute('aria-checked', isSelected);
  });
}

function closeGenreMenu() {
  genreModalContainer.classList.remove('open');
  genreToggle.setAttribute('aria-expanded', 'false');
}

genreToggle.addEventListener('click', (e) => {
  e.stopPropagation();
  buildGenreMenu();
  const isOpening = !genreModalContainer.classList.contains('open');
  genreToggle.setAttribute('aria-expanded', isOpening);
  genreModalContainer.classList.toggle('open');
});

genreOverlay.addEventListener('click', closeGenreMenu);
genreMenuCloseBtn.addEventListener('click', closeGenreMenu);
document.addEventListener('click', (e) => {
  if (window.innerWidth >= 768 && !genreMenu.contains(e.target) && e.target !== genreToggle) {
    closeGenreMenu();
  }
});

function formatMovie(movieData) {
  return {
    id: movieData.id,
    title: movieData.title,
    year: movieData.release_date ? movieData.release_date.slice(0, 4) : 'N/A',
    poster_path: movieData.poster_path,
    genre_ids: movieData.genre_ids,
    watch_link: movieData.watch_link
  };
}

function createResponsivePosterHtml(path) {
  const imageUrl = `${IMG_BASE}w500${path}`;
  return `<div class="filmstrip-image" style="background-image: url('${imageUrl}')" role="img" aria-label="Movie poster"></div>`;
}

async function initializeApp() {
  btn.disabled = true;
  try {
    const response = await fetch('data/movies.json');
    if (!response.ok) throw new Error('Could not load the movie list.');
    const rawMovieList = await response.json();
    movies = rawMovieList.map(formatMovie).filter(m => m.poster_path);
    fullMovieList = movies;
    if (movies.length === 0) {
      throw new Error('No movies with posters found.');
    }
    
    // PERFORMANCE: Use the preloaded movie first, with a random fallback.
    let firstMovie = movies.find(m => m.id === DEFAULT_MOVIE_ID);
    if (!firstMovie) {
        firstMovie = movies[Math.floor(Math.random() * movies.length)];
    }
    
    // The <link rel="preload"> tag already started this download.
    await preloadImages([`${IMG_BASE}w500${firstMovie.poster_path}`]);
    pickNewMovie(firstMovie);
    seenMovies.push(firstMovie);
    btn.disabled = false;
  } catch (err) {
    console.error(err);
    loadingPlaceholder.querySelector('div').innerHTML = `<div>Oops! Could not load movies.</div>`;
  }
}

function pickNewMovie(movie) {
  loadingPlaceholder.classList.add('hidden'); // Hide loading indicator
  loadingPlaceholder.querySelector('div').textContent = 'Loading movie...'; // Reset text for next time

  if (!movie) {
    filmstrip.innerHTML = '';
    txt.textContent = 'No movies match the selected genres.';
    streamLink.href = '#';
    streamLink.classList.add('hidden');
    res.style.visibility = 'visible';
    btn.textContent = 'Reset';
    return;
  }
  btn.textContent = 'Randomize Movie';
  filmstrip.style.transition = 'none';
  filmstrip.innerHTML = createResponsivePosterHtml(movie.poster_path);
  filmstrip.style.transform = 'translateY(0)';
  txt.textContent = `${movie.title} (${movie.year})`;
  streamLink.href = movie.watch_link || `${TMDB_BASE}/${movie.id}/watch`;
  streamLink.classList.remove('hidden');
  res.style.visibility = 'visible';
  if (!seenMovies.some(sm => sm.id === movie.id)) {
    seenMovies.unshift(movie);
    if (seenMovies.length > SEEN_MOVIES_CAP) seenMovies.pop();
  }
}

async function randomize() {
  if (isSpinning || movies.length === 0) return;
  isSpinning = true;
  btn.disabled = true;
  try {
    let pool = fullMovieList.filter(m => !seenMovies.some(sm => sm.id === m.id));
    if (pool.length === 0) {
      const currentMovieId = seenMovies[0]?.id;
      seenMovies = currentMovieId ? [{ id: currentMovieId }] : [];
      pool = fullMovieList.filter(m => m.id !== currentMovieId);
    }
    const fs = [...selectedGenres].filter(g => g !== 0);
    if (fs.length > 0) {
      pool = pool.filter(m => fs.every(g => m.genre_ids.includes(g)));
    }
    if (pool.length === 0) {
      pickNewMovie(null);
      return;
    }
    const winner = pool[Math.floor(Math.random() * pool.length)];
    await performFastSpin(winner);
    // No need to preload here, spin provides enough time.
    pickNewMovie(winner);
  } catch (error) {
    console.error("An error occurred during randomization:", error);
    txt.textContent = "Oops! Something went wrong.";
    pickNewMovie(seenMovies[0] || null); // Go back to last movie on error
  } finally {
    isSpinning = false;
    btn.disabled = false;
  }
}

async function performFastSpin(winner) {
  const stripLength = 30;
  const poolSize = 15; // Use a small pool of images for efficiency
  let stripHTML = '';
  const posterHeight = filmstrip.clientHeight;
  if (posterHeight === 0) return;

  const animationPool = [];
  for (let i = 0; i < poolSize; i++) {
    animationPool.push(fullMovieList[Math.floor(Math.random() * fullMovieList.length)]);
  }
  
  for (let i = 0; i < stripLength; i++) {
    const movieForStrip = animationPool[i % poolSize];
    const divHTML = createResponsivePosterHtml(movieForStrip.poster_path);
    stripHTML += divHTML.replace('style="', `style="top: ${i * 100}%; `);
  }

  const winnerDivHTML = createResponsivePosterHtml(winner.poster_path);
  stripHTML += winnerDivHTML.replace('style="', `style="top: ${stripLength * 100}%; `);
  
  filmstrip.style.transition = 'none';
  filmstrip.style.transform = 'translateY(0)';
  filmstrip.innerHTML = stripHTML;
  
  await new Promise(r => requestAnimationFrame(() => r()));
  
  txt.textContent = 'Finding a movie...';
  const finalPosition = -posterHeight * stripLength;
  filmstrip.style.transition = 'transform 2.5s cubic-bezier(.25,.1,.25,1)';
  filmstrip.style.transform = `translateY(${finalPosition}px)`;
  
  await new Promise(resolve => {
    const fallback = setTimeout(() => {
      console.warn('Animation fallback timer fired.');
      resolve();
    }, 2600);
    filmstrip.addEventListener('transitionend', () => {
      clearTimeout(fallback);
      resolve();
    }, { once: true });
  });
}

function preloadImages(srcArray) {
  const promises = srcArray.map(src => new Promise((resolve) => {
    const img = new Image();
    img.onload = resolve;
    img.onerror = resolve; // Resolve on error too so it doesn't block
    img.src = src;
  }));
  return Promise.all(promises);
}

btn.addEventListener('click', () => {
  if (btn.textContent === 'Reset') {
    selectedGenres.clear();
    selectedGenres.add(0);
    updateGenreSelection();
    randomize();
  } else {
    randomize();
  }
});

// Start the application
initializeApp();
